//Profile config names for nf-core/configs
params {
    config_profile_description = 'Centre for Genomic Regulation (CRG) cluster profile - Optimized for VAST-tools'
    config_profile_contact = 'Jose Espinosa-Carrasco (@joseespinosa)'
    config_profile_url = 'http://www.linux.crg.es/index.php/Main_Page'
}

if (System.getenv("SLURM_CONF")) {
    process {
        executor = 'slurm'
        queue    = 'genoa64'

        // Dynamic QOS selection based on time
        clusterOptions = {
            switch (task.time) {
                case { it > 168.h }:
                    return '--qos=ethernal'
                case (48.h..168.h):
                    return '--qos=marathon'
                case (24.h..48.h):
                    return '--qos=vlong'
                case (12.h..24.h):
                    return '--qos=long'
                case (6.h..12.h):
                    return '--qos=normal'
                case (3.h..6.h):
                    return '--qos=short'
                case (1.h..3.h):
                    return '--qos=shorter'
                default:
                    return '--qos=vshort'
            }
        }

        // Process-specific optimizations for memory-intensive tasks
        withName: 'combine_results' {
            queue = 'genoa64'
            cpus = 4
            memory = { 16.GB * task.attempt }
            time = { 3.h * task.attempt }
            maxRetries = 3
            errorStrategy = { task.exitStatus in [140, 139, 137, 143, 1] ? 'retry' : 'terminate' }

            // Additional SLURM options for large memory jobs
            clusterOptions = {
                def qos = task.time > 6.h ? '--qos=normal' : '--qos=short'
                return "${qos} --mem=${task.memory.toGiga()}G"
            }
        }

        withName: 'align_reads' {
            cpus = 8
            memory = { 30.GB * task.attempt }
            time = { 25.h * task.attempt }
            maxRetries = 2
        }

        withName: 'run_trim_galore' {
            cpus = 4
            memory = { 32.GB * task.attempt }
            time = { 2.h * task.attempt }
            maxRetries = 3
        }

        withName: 'run_betas_simulation' {
            cpus = 2
            memory = 60.GB
            time = 72.h
            queue = 'genoa64'
            clusterOptions = '--qos=vlong --mem=60G'
        }
    }
} else {
    process {
        executor = 'crg'
        beforeScript = 'module load Singularity/4.0.2'
        queue = 'short-centos79,long-centos79'

        // Process-specific settings for non-SLURM environment
        withName: 'combine_results' {
            queue = 'long-centos79'
            cpus = 4
            memory = { 16.GB * task.attempt }
            time = { 3.h * task.attempt }
            maxRetries = 3
        }
    }
}

singularity {
    enabled = true
    autoMounts = true

    // Ensure proper environment variable handling
    envWhitelist = 'SINGULARITY_BINDPATH,SINGULARITYENV_VASTDB,SINGULARITYENV_TMPDIR'

    // Add cache directory for Singularity images
    cacheDir = '/nfs/scratch01/aaljord/agordo/singularity'

    // Pull timeout for large containers
    pullTimeout = '60 min'
}

// Set environment variables for container binding
env {
    // Bind VASTDB path to a specific location in the container
    SINGULARITY_BINDPATH = params.vastdb_path ? "${params.vastdb_path}:/usr/local/vast-tools/VASTDB" : ""

    // Set VASTDB environment variable as a backup
    SINGULARITYENV_VASTDB = params.vastdb_path

    // Ensure temp directory is properly set
    SINGULARITYENV_TMPDIR = '/tmp'
}

// Process-specific container configuration
process {
    // VAST-tools processes
    withName: 'align_reads|combine_results|compare_groups' {
        container = 'andresgordoortiz/vast-tools:latest'

        // Container binding: only bind VASTDB, do NOT use --cleanenv or --no-home
        // --cleanenv strips env vars needed by R scripts inside vast-tools combine,
        //   causing RI_MakeTablePIR.R to hang waiting for stdin.
        // --no-home prevents R from finding libraries.
        // --writable-tmpfs wastes memory budget.
        containerOptions = {
            if (workflow.containerEngine == 'singularity') {
                return "--bind ${params.vastdb_path}:/usr/local/vast-tools/VASTDB"
            }
            return ''
        }
    }

    // MATT analysis processes
    withName: 'run_matt_exons|run_matt_introns' {
        container = 'andresgordoortiz/matt-container:latest'
    }

    // R-based analysis processes
    withName: 'prepare_betas_data|run_betas_simulation|run_rmarkdown_report' {
        container = 'andresgordoortiz/splicing_analysis_r_crg:v1.5'
    }
}

// Execution report settings
timeline {
    enabled = true
    file = "${params.outdir}/execution_timeline.html"
}

report {
    enabled = true
    file = "${params.outdir}/execution_report.html"
}

trace {
    enabled = true
    file = "${params.outdir}/execution_trace.txt"
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes'
}

dag {
    enabled = true
    file = "${params.outdir}/pipeline_dag.html"
}